var Mapbox=function(){"use strict";function o(o,e,n){if("string"==typeof w[o]){var t=$(w[o]);t.val(e),n&&t.trigger("input")}}function e(e,n){for(var t="Unnamed Road",a="",i=0,r=0;r<e.address_components.length;r++)switch(e.address_components[r].types[0]){case"street_number":a=e.address_components[r].long_name;break;case"postal_code":i=e.address_components[r].long_name;break;case"route":t=e.address_components[r].long_name}o("address",t+" "+a),o("street_name",t),o("post_code",i,!0),o("user_location",e.formatted_address,!0),o("latitude",n.lat),o("longitude",n.lng)}function n(o){d=new google.maps.Geocoder,d.geocode({location:o},function(n,t){t===google.maps.GeocoderStatus.OK&&n[0]&&(u.jumpTo({center:[o.lng,o.lat],zoom:u.getZoom()||f}),$("#reportform-user_location").val(n[0].formatted_address),e(n[0],o))})}function t(o){setTimeout(function(){o()},0)}function a(){t(function(){u.resize()})}function i(){["fullscreenchange","mozfullscreenchange","webkitfullscreenchange","msfullscreenchange"].forEach(function(o){document.addEventListener(o,function(){a()})})}function r(){return!!window.mapInitData.locationChangeHandler}function c(o){var e=document.createElement("img");e.className="marker",e.src="https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png",e.style.width="27px",e.style.height="43px",m=new mapboxgl.Marker(e,{draggable:o}),r()&&m.on("dragend",function(){n(m.getLngLat())})}function l(){if("none"!==$("[step=2]").css("display")){i();var o=$(".step--final").css("display");"block"===o?$(".mapboxgl-ctrl-group").hide():$(".mapboxgl-ctrl-group").show();var e=m.getLngLat();m.remove(),c("block"!==o),k(e)}}function s(){var o=$("#report-create-form");o.length>0&&o.yiiActiveForm("validate")}function g(o,e){var n=new google.maps.InfoWindow({map:u});n.setPosition(e),n.setContent(o?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")}mapboxgl.accessToken=window.mapboxToken;var d,m,p,u,f=window.mapInitData.zoom,w=window.mapInitData.selectors,v=window.mapInitData.center.lng,_=window.mapInitData.center.lat,h=!0,y=window.mapInitData.mapLayers,b=window.mapInitData.enableGeoCodeService||!1,k=function(o){m.setLngLat([o.lng,o.lat]).addTo(u)},x=function(o){n(o),k(o)};$(".button--large").on("click",function(){$("[step=1]:visible").length&&a(),t(l)}),$(".steps__icon").on("click",function(){t(function(){$("[step=2]:visible").length&&h&&(h=!1,a()),l()})});var L=function(){"string"==typeof w.user_location&&(p=new google.maps.places.Autocomplete($(w.user_location)[0],{types:["address"],componentRestrictions:{country:"hu"}}),p.addListener("place_changed",function(){var o=p.getPlace();if(o.geometry&&o.geometry&&o.geometry.location){var e=o.geometry.location.lng(),n=o.geometry.location.lat();x({lng:e,lat:n})}}),$(w.show_on_map).on("click",function(){d.geocode({address:$(w.user_location).val()},function(o,e){if(e===google.maps.GeocoderStatus.OK&&o[0]){var n=o[0].geometry.location.lng(),t=o[0].geometry.location.lat();x({lng:n,lat:t}),s()}})}),$(w.show_me_on_map).on("click",function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){var e=o.coords.longitude,n=o.coords.latitude;x({lng:e,lat:n})}):g(!1,u.getCenter())}),$(w.user_location).on("keydown",function(o){13===o.keyCode&&(o.preventDefault(),$(w.show_on_map).trigger("click"))}))},C=function(){L(),u=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[v,_],zoom:f}),o("zoom",f),u.on("zoom",function(){o("zoom",Math.round(u.getZoom()))}),c(!0),b?x({lng:v,lat:_}):k({lng:v,lat:_}),r()&&u.on("click",function(o){x({lng:o.lngLat.lng,lat:o.lngLat.lat})}),u.addControl(new mapboxgl.FullscreenControl),u.addControl(new mapboxgl.NavigationControl,"bottom-right"),$(document).trigger("mapReady",u),y.length>0&&u.on("load",function(){var o=document.createElement("script");o.onload=function(){for(var o=window.MAPLAYERDATA,e=0;e<o.length;e++)u.addLayer({id:"regionlayer_line_"+e,type:"line",source:{type:"geojson",data:JSON.parse(o[e].data)[0]},paint:{"line-color":o[e].color||"blue","line-width":3,"line-opacity":.5}})};var e=function(o,e){return e=e.map(encodeURIComponent),"?"+o+"[]="+e.join("&"+o+"[]=")};o.src="/get-map-layer.js"+e("id",y),document.getElementsByTagName("head")[0].appendChild(o)})};return{initMap:C}}();