function nodeVal(e){return e&&e.normalize&&e.normalize(),e&&e.textContent||""}function getLineStyle(e){var t={};if(e){var r=get1(e,"line");if(r){var n=nodeVal(get1(r,"color")),a=parseFloat(nodeVal(get1(r,"opacity"))),o=parseFloat(nodeVal(get1(r,"width")));n&&(t.stroke=n),isNaN(a)||(t["stroke-opacity"]=a),isNaN(o)||(t["stroke-width"]=96*o/25.4)}}return t}function getMulti(e,t){var r,n,a={};for(n=0;n<t.length;n++)r=get1(e,t[n]),r&&(a[t[n]]=nodeVal(r));return a}function getProperties(e){var t=getMulti(e,["name","cmt","desc","type","time","keywords"]),r=e.getElementsByTagName("link");r.length&&(t.links=[]);for(var n=0;n<r.length;n++)t.links.push(Object.assign({href:r[n].getAttribute("href")},getMulti(r[n],["text","type"])));return t}function get1(e,t){var r=e.getElementsByTagName(t);return r.length?r[0]:null}function coordPair(e){var t,r=[parseFloat(e.getAttribute("lon")),parseFloat(e.getAttribute("lat"))],n=get1(e,"ele"),a=get1(e,"gpxtpx:hr")||get1(e,"hr"),o=get1(e,"time");return n&&(t=parseFloat(nodeVal(n)),isNaN(t)||r.push(t)),{coordinates:r,time:o?nodeVal(o):null,heartRate:a?parseFloat(nodeVal(a)):null}}function getRoute(e){var t=getPoints(e,"rtept");if(t.line)return{type:"Feature",properties:Object.assign(getProperties(e),getLineStyle(get1(e,"extensions"))),geometry:{type:"LineString",coordinates:t.line}}}function getPoints(e,t){var r=e.getElementsByTagName(t),n=[],a=[],o=r.length,i=void 0;if(o<2)return{};for(var l=0;l<o;l++){var g=coordPair(r[l]);n.push(g.coordinates),g.time&&a.push(g.time),(g.heartRate||i)&&(i||(i=Array(l).fill(null)),i.push(g.heartRate||null))}return{line:n,times:a,heartRates:i||[]}}function getTrack(e){for(var t,r=e.getElementsByTagName("trkseg"),n=[],a=[],o=[],i=0;i<r.length;i++)if(t=getPoints(r[i],"trkpt"),t&&(t.line&&n.push(t.line),t.times&&t.times.length&&a.push(t.times),o.length||t.heartRates&&t.heartRates.length)){if(!o.length)for(var l=0;l<i;l++)o.push(Array(n[l].length).fill(null));t.heartRates&&t.heartRates.length?o.push(t.heartRates):o.push(Array(t.line.length||0).fill(null))}if(0!==n.length){var g=Object.assign(getProperties(e),getLineStyle(get1(e,"extensions")));return a.length&&(g.coordTimes=1===n.length?a[0]:a),o.length&&(g.heartRates=1===n.length?o[0]:o),{type:"Feature",properties:g,geometry:{type:1===n.length?"LineString":"MultiLineString",coordinates:1===n.length?n[0]:n}}}}function getPoint(e){return{type:"Feature",properties:Object.assign(getProperties(e),getMulti(e,["sym"])),geometry:{type:"Point",coordinates:coordPair(e).coordinates}}}function gpxGen(e){for(var t=e.getElementsByTagName("trk"),r=e.getElementsByTagName("rte"),n=e.getElementsByTagName("wpt"),a=[],o=0;o<t.length;o++){var i=getTrack(t[o]);i&&a.push(i)}for(var o=0;o<r.length;o++){var i=getRoute(r[o]);i&&a.push(i)}for(var o=0;o<n.length;o++)a.push(getPoint(n[o]));return a}function gpx(e){return{type:"FeatureCollection",features:Array.from(gpxGen(e))}}function okhash(e){if(!e||!e.length)return 0;for(var t=0,r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r)|0;return t}function get1$1(e,t){var r=e.getElementsByTagName(t);return r.length?r[0]:null}function coord1(e){return e.replace(removeSpace,"").split(",").map(parseFloat)}function coord(e){return e.replace(trimSpace,"").split(splitSpace).map(coord1)}function xml2str(e){if(void 0!==e.xml)return e.xml;if(e.tagName){for(var t=e.tagName,r=0;r<e.attributes.length;r++)t+=e.attributes[r].name+e.attributes[r].value;for(var r=0;r<e.childNodes.length;r++)t+=xml2str(e.childNodes[r]);return t}return"#text"===e.nodeName?(e.nodeValue||e.value||"").trim():"#cdata-section"===e.nodeName?e.nodeValue:""}function kmlColor(e){var t,r;return e=e||"","#"===e.substr(0,1)&&(e=e.substr(1)),6!==e.length&&3!==e.length||(t=e),8===e.length&&(r=parseInt(e.substr(0,2),16)/255,t="#"+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)),[t,isNaN(r)?void 0:r]}function gxCoords(e){var t=e.getElementsByTagName("coord"),r=[],n=[];0===t.length&&(t=e.getElementsByTagName("gx:coord"));for(var a=0;a<t.length;a++)r.push(nodeVal(t[a]).split(" ").map(parseFloat));for(var o=e.getElementsByTagName("when"),i=0;i<o.length;i++)n.push(nodeVal(o[i]));return{coords:r,times:n}}function getGeometry(e){var t,r,n,a,o,i=[],l=[];if(get1$1(e,"MultiGeometry"))return getGeometry(get1$1(e,"MultiGeometry"));if(get1$1(e,"MultiTrack"))return getGeometry(get1$1(e,"MultiTrack"));if(get1$1(e,"gx:MultiTrack"))return getGeometry(get1$1(e,"gx:MultiTrack"));for(n=0;n<geotypes.length;n++)if(r=e.getElementsByTagName(geotypes[n]))for(a=0;a<r.length;a++)if(t=r[a],"Point"===geotypes[n])i.push({type:"Point",coordinates:coord1(nodeVal(get1$1(t,"coordinates")))});else if("LineString"===geotypes[n])i.push({type:"LineString",coordinates:coord(nodeVal(get1$1(t,"coordinates")))});else if("Polygon"===geotypes[n]){var g=t.getElementsByTagName("LinearRing"),s=[];for(o=0;o<g.length;o++)s.push(coord(nodeVal(get1$1(g[o],"coordinates"))));i.push({type:"Polygon",coordinates:s})}else if("Track"===geotypes[n]||"gx:Track"===geotypes[n]){var u=gxCoords(t);i.push({type:"LineString",coordinates:u.coords}),u.times.length&&l.push(u.times)}return{geoms:i,coordTimes:l}}function getPlacemark(e,t,r,n){var a,o=getGeometry(e),i={},l=nodeVal(get1$1(e,"name")),g=nodeVal(get1$1(e,"address")),s=nodeVal(get1$1(e,"styleUrl")),u=nodeVal(get1$1(e,"description")),m=get1$1(e,"TimeSpan"),p=get1$1(e,"TimeStamp"),c=get1$1(e,"ExtendedData"),h=get1$1(e,"LineStyle"),d=get1$1(e,"PolyStyle"),y=get1$1(e,"visibility");if(o.geoms.length){if(l&&(i.name=l),g&&(i.address=g),s){"#"!==s[0]&&(s="#"+s),i.styleUrl=s,t[s]&&(i.styleHash=t[s]),r[s]&&(i.styleMapHash=r[s],i.styleHash=t[r[s].normal]);var f=n[i.styleHash];if(f){h||(h=get1$1(f,"LineStyle")),d||(d=get1$1(f,"PolyStyle"));var v=get1$1(f,"IconStyle");if(v){var N=get1$1(v,"Icon");if(N){var k=nodeVal(get1$1(N,"href"));k&&(i.icon=k)}}}}if(u&&(i.description=u),m){var T=nodeVal(get1$1(m,"begin")),$=nodeVal(get1$1(m,"end"));i.timespan={begin:T,end:$}}if(p&&(i.timestamp=nodeVal(get1$1(p,"when"))),h){var V=kmlColor(nodeVal(get1$1(h,"color"))),S=V[0],b=V[1],P=parseFloat(nodeVal(get1$1(h,"width")));S&&(i.stroke=S),isNaN(b)||(i["stroke-opacity"]=b),isNaN(P)||(i["stroke-width"]=P)}if(d){var x=kmlColor(nodeVal(get1$1(d,"color"))),E=x[0],B=x[1],A=nodeVal(get1$1(d,"fill")),F=nodeVal(get1$1(d,"outline"));E&&(i.fill=E),isNaN(B)||(i["fill-opacity"]=B),A&&(i["fill-opacity"]="1"===A?i["fill-opacity"]||1:0),F&&(i["stroke-opacity"]="1"===F?i["stroke-opacity"]||1:0)}if(c){var L=c.getElementsByTagName("Data"),M=c.getElementsByTagName("SimpleData");for(a=0;a<L.length;a++)i[L[a].getAttribute("name")]=nodeVal(get1$1(L[a],"value"));for(a=0;a<M.length;a++)i[M[a].getAttribute("name")]=nodeVal(M[a])}y&&(i.visibility=nodeVal(y)),o.coordTimes.length&&(i.coordTimes=1===o.coordTimes.length?o.coordTimes[0]:o.coordTimes);var R={type:"Feature",geometry:1===o.geoms.length?o.geoms[0]:{type:"GeometryCollection",geometries:o.geoms},properties:i};return e.getAttribute("id")&&(R.id=e.getAttribute("id")),R}}function kmlGen(e){for(var t={},r={},n={},a=e.getElementsByTagName("Placemark"),o=e.getElementsByTagName("Style"),i=e.getElementsByTagName("StyleMap"),l=[],g=0;g<o.length;g++){var s=okhash(xml2str(o[g])).toString(16);t["#"+o[g].getAttribute("id")]=s,r[s]=o[g]}for(var u=0;u<i.length;u++){t["#"+i[u].getAttribute("id")]=okhash(xml2str(i[u])).toString(16);for(var m=i[u].getElementsByTagName("Pair"),p={},c=0;c<m.length;c++)p[nodeVal(get1$1(m[c],"key"))]=nodeVal(get1$1(m[c],"styleUrl"));n["#"+i[u].getAttribute("id")]=p}for(var h=0;h<a.length;h++){var d=getPlacemark(a[h],t,n,r);d&&l.push(d)}return l}function kml(e){return{type:"FeatureCollection",features:Array.from(kmlGen(e))}}var removeSpace=/\s*/g,trimSpace=/^\s*|\s*$/g,splitSpace=/\s+/,geotypes=["Polygon","LineString","Point","Track","gx:Track"];